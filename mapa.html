<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mockup: El Mapa del Afecto </title>
    
    <!-- Librería de Mapeo Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&family=Roboto+Mono:wght@300;400&display=swap" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background-color: #0a0a0a;
            font-family: 'Roboto Mono', monospace;
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #0a0a0a;
            z-index: 1;
            opacity: 0; /* Empieza oculto */
            transition: opacity 2s ease-in;
        }
        .leaflet-tile-pane {
            filter: grayscale(1) brightness(0.7) contrast(1.1);
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none;
        }
        #intro-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            background-color: #0a0a0a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 1.5s ease-out;
        }
        #intro-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #intro-overlay h1 {
            font-family: 'Major Mono Display', monospace;
            font-size: 2rem;
            color: #f0f0f0;
            text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 15px #ff00ff;
            animation: flicker 3s infinite alternate;
        }
        #intro-overlay p {
            font-size: 0.9rem;
            color: #cccccc;
            margin-top: 1rem;
            max-width: 80%;
            text-shadow: 0 0 3px #ff00ff;
        }
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            font-size: 0.8rem;
            color: #a0a0a0;
            text-shadow: 0 0 5px #000;
            background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0));
            pointer-events: none;
            opacity: 0;
            transition: opacity 2s ease-in 1s;
        }

        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                text-shadow: 0 0 4px #fff, 0 0 11px #ff00ff, 0 0 19px #ff00ff;
            }
            20%, 24%, 55% { text-shadow: none; }
        }
        @media (min-width: 768px) {
            #intro-overlay h1 { font-size: 3.5rem; }
            #intro-overlay p { font-size: 1.1rem; }
            .status-bar { font-size: 1rem; padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div id="intro-overlay">
        <h1>&lt;Esperando_Conexión&gt;</h1>
        <p>El Mapa del Afecto</p>
    </div>

    <div id="map"></div>
    
    <canvas id="animationCanvas"></canvas>

    <div class="status-bar">
        <span>CONEXIONES ACTIVAS: <span id="userCount">143</span></span>
        <span id="clock">00:00:00</span>
    </div>

    <script>
        // --- 1. Configuración del Mapa Real (Leaflet.js) ---
        const mapElement = document.getElementById('map');
        const defaultCoords = [-36.827, -73.050]; // Concepción
        const map = L.map('map', {
            center: defaultCoords,
            zoom: 5,
            minZoom: 3,
            zoomControl: false,
            attributionControl: false,
        });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
        }).addTo(map);

        // --- 2. Configuración del Canvas de Animación ---
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');

        const neonPink = '#ff00ff';
        const darkPink = '#8B008B';
        const visitorColor = '#00ffff'; // Color para el visitante

        const heartCoordinates = [
            [-36.820, -73.045], [-36.835, -73.060], [-36.828, -73.038], // Concepción
            [-33.448, -70.669], [-33.458, -70.649], // Santiago
            [40.712, -74.006], [35.689, 139.691], [48.856, 2.352]
        ];

        let points = [];
        let revealFactor = 0;
        let startAnimation = false;

        class Point {
            constructor(lat, lng, id, isVisitor = false) {
                this.lat = lat;
                this.lng = lng;
                this.id = id;
                this.isVisitor = isVisitor;
                this.radius = isVisitor ? 4 : Math.random() * 2.5 + 1.5;
                this.originalRadius = this.radius;
                this.color = isVisitor ? visitorColor : neonPink;
                this.pulseSpeed = isVisitor ? 0.06 : Math.random() * 0.05 + 0.01;
                this.pulsePhase = Math.random() * Math.PI * 2;
                this.neighbors = [];
            }

            getPixelPos() {
                return map.latLngToContainerPoint(new L.LatLng(this.lat, this.lng));
            }

            draw() {
                const pos = this.getPixelPos();
                ctx.globalAlpha = revealFactor;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = (this.isVisitor ? 22 : 18) * revealFactor;
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }

            update() {
                this.pulsePhase += this.pulseSpeed;
                this.radius = this.originalRadius + Math.sin(this.pulsePhase) * this.originalRadius * 0.7;
            }
        }

        function setupCanvas(visitorCoords = null) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Crear puntos fijos
            points = heartCoordinates.map((coords, index) => new Point(coords[0], coords[1], index));
            
            // Añadir el punto del visitante si se obtuvieron las coordenadas
            if (visitorCoords) {
                const visitorPoint = new Point(visitorCoords.lat, visitorCoords.lng, 'visitor', true);
                points.push(visitorPoint);
            }
            
            // Conectar cada punto a otros 2 puntos aleatorios
            points.forEach(p1 => {
                const otherPoints = points.filter(p => p.id !== p1.id);
                const shuffled = otherPoints.sort(() => 0.5 - Math.random());
                p1.neighbors = shuffled.slice(0, 2);
            });
        }
        
        function drawMicelio() {
            ctx.strokeStyle = darkPink;
            ctx.lineWidth = 0.4;
            ctx.shadowBlur = 0;

            points.forEach(p1 => {
                const pos1 = p1.getPixelPos();
                p1.neighbors.forEach(p2 => {
                    const pos2 = p2.getPixelPos();
                    ctx.beginPath();
                    ctx.moveTo(pos1.x, pos1.y);
                    ctx.lineTo(pos2.x, pos2.y);
                    ctx.globalAlpha = 0.6 * revealFactor;
                    ctx.stroke();
                });
            });
            ctx.globalAlpha = 1.0;
        }

        function animate() {
            if (startAnimation) {
                if (revealFactor < 1) { revealFactor += 0.01; }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawMicelio();
                points.forEach(point => { point.update(); point.draw(); });
            }
            requestAnimationFrame(animate);
        }

        // --- 3. Lógica de Geolocalización y Secuencia ---
        const introOverlay = document.getElementById('intro-overlay');
        const statusBar = document.querySelector('.status-bar');

        function startExperience(coords) {
            // Centrar mapa y establecer zoom
            map.setView(coords, 13, { animate: true, pan: { duration: 2 } });
            
            // Configurar el canvas con la ubicación del visitante
            setupCanvas({ lat: coords[0], lng: coords[1] });
            
            // Iniciar la secuencia de aparición
            setTimeout(() => {
                introOverlay.classList.add('hidden');
                mapElement.style.opacity = 1;
                statusBar.style.opacity = 1;
                setTimeout(() => {
                    startAnimation = true;
                }, 1500);
            }, 4000);
        }

        window.onload = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userCoords = [position.coords.latitude, position.coords.longitude];
                        startExperience(userCoords);
                    },
                    () => {
                        // Si el usuario niega el permiso, empezar en Concepción
                        startExperience(defaultCoords);
                    }
                );
            } else {
                // Si el navegador no soporta geolocalización
                startExperience(defaultCoords);
            }
        };

        // --- 4. Barra de estado y otros ---
        const redraw = () => {
            if(startAnimation) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawMicelio();
                points.forEach(point => point.draw());
            }
        };
        map.on('move', redraw);
        map.on('zoom', redraw);
        window.addEventListener('resize', () => { setupCanvas(); redraw(); });

        const clockElement = document.getElementById('clock');
        const userCountElement = document.getElementById('userCount');
        let baseUserCount = 143;
        function updateClock() {
            clockElement.textContent = new Date().toLocaleTimeString('es-CL');
        }
        function updateUserCount() {
            const fluctuation = Math.floor(Math.random() * 7) - 3;
            baseUserCount = Math.max(120, baseUserCount + fluctuation);
            userCountElement.textContent = baseUserCount;
        }
        
        animate(); // Inicia el bucle de animación
        setInterval(updateClock, 1000);
        setInterval(updateUserCount, 3500);
        updateClock();
    </script>
</body>
</html>
